#!/bin/bash
# wp-sync - WordPress環境同期ツール
#
# 使用方法:
#   wp-sync prd-to-stg    本番 → ステージング同期
#   wp-sync stg-to-prd    ステージング → 本番同期
#
# 実行前に、カレントディレクトリに .wp-sync/ が存在することを確認してください。

set -e

# wp-sync リポジトリのディレクトリを取得
WP_SYNC_DIR="$(cd "$(dirname "$0")/.." && pwd)"
export WP_SYNC_DIR

# ライブラリの読み込み
# shellcheck source=/dev/null
. "$WP_SYNC_DIR/lib/log.sh"
# shellcheck source=/dev/null
. "$WP_SYNC_DIR/lib/restore.sh"

# .wp-sync ディレクトリの存在確認
if [ ! -d ".wp-sync" ]; then
  echo "エラー: .wp-sync ディレクトリが見つかりません。" >&2
  echo "WordPressプロジェクトのルートディレクトリから実行してください。" >&2
  exit 1
fi

# 終了時の処理（エラー時はロールバック）
cleanup() {
  local exit_code=$?

  if [ $exit_code -ne 0 ]; then
    # エラー時はロールバックを試行
    perform_rollback
  fi

  finalize_log
  exit $exit_code
}
trap cleanup EXIT

case "$1" in
  prd-to-stg)
    init_log "prd-to-stg"
    set_restore_target "stg"
    log_info "本番 → ステージング同期を開始します..."
    log_info "ログファイル: $(get_log_file)"
    echo ""
    # shellcheck source=/dev/null
    . "$WP_SYNC_DIR/scripts/sync.sh" "prd-to-stg"
    log_success "本番 → ステージング同期が完了しました"
    ;;
  stg-to-prd)
    init_log "stg-to-prd"
    set_restore_target "prd"
    log_info "ステージング → 本番同期を開始します..."
    log_info "ログファイル: $(get_log_file)"
    echo ""
    # shellcheck source=/dev/null
    . "$WP_SYNC_DIR/scripts/sync.sh" "stg-to-prd"
    log_success "ステージング → 本番同期が完了しました"
    ;;
  -h|--help|help)
    echo "wp-sync - WordPress環境同期ツール"
    echo ""
    echo "使用方法:"
    echo "  wp-sync prd-to-stg    本番 → ステージング同期"
    echo "  wp-sync stg-to-prd    ステージング → 本番同期"
    echo "  wp-sync help          このヘルプを表示"
    echo ""
    echo "実行前に、カレントディレクトリに .wp-sync/ が存在することを確認してください。"
    echo ""
    echo "ログファイル:"
    echo "  .wp-sync/logs/ に保存されます（${LOG_RETENTION_DAYS}日間保持）"
    ;;
  *)
    echo "使用方法: wp-sync {prd-to-stg|stg-to-prd|help}" >&2
    exit 1
    ;;
esac
